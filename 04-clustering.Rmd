---
title: "Clustering"
author: "Data Lab for ALSF"
date: "2022"
output:
  html_notebook:
    toc: yes
    toc_float: yes
  html_document:
    toc: yes
    df_print: paged
---

This notebook will begin looking at clustering methods on the expression of the genes in a single sample of the dataset of interest, from an unbiased approach.

## Set Up 

```{r}
# Load libraries
library(magrittr)
library(scater)
library(readr)
library(bluster)
library(ggpubr)
library(pheatmap)

# Set file paths
data_dir <- file.path("results", "Gawad_processed_data")

# Source custom functions script
source(file.path("utils", "clustering-functions.R"))
```

## Read in data

```{r}
sample_290_normalized <- read_rds(
  file.path(data_dir, "SCPCS000216", "SCPCL000290_miQC_processed_sce.rds"))
```

## Perform clustering

### k-means

```{r fig.height = 10.5}
# Perform k-means clustering
sample_290_normalized <- kmeans_clustering(
  sample_290_normalized,
  params_range = c(4:10),
  step_size = 1
)

# grab column names with clustering results
kmeans_cols <- grep("kmeans", colnames(colData(sample_290_normalized)))
kmeans_cluster_names <- colnames(colData(sample_290_normalized)[, kmeans_cols])

# Plot k-means
kmeans_plot_list <- kmeans_cluster_names %>%
  purrr::map(~ plotReducedDim(sample_290_normalized, dimred = "UMAP", colour_by = .x) + 
               theme_bw()+
               theme(text = element_text(size = 22)))

cowplot::plot_grid(plotlist = kmeans_plot_list, ncol = 4)
```

### graph-based, walktrap

```{r fig.height = 9.5}
# Perform graph-based walktrap clustering
sample_290_normalized <- graph_clustering(
  sample_290_normalized,
  params_range = c(5:25),
  step_size = 5,
  weighting_type = "rank",
  cluster_function = "walktrap"
)

# grab column names with clustering results
walktrap_cols <- grep("walktrap", colnames(colData(sample_290_normalized)))
walktrap_cluster_names <- colnames(colData(sample_290_normalized)[, walktrap_cols])

# Plot
walktrap_plot_list <- walktrap_cluster_names %>%
   purrr::map(~ plotReducedDim(sample_290_normalized, dimred = "UMAP", colour_by = .x) + 
                theme_bw() +
                theme(text = element_text(size = 22)))

cowplot::plot_grid(plotlist = walktrap_plot_list, ncol = 3)
```

### graph-based, louvain

```{r fig.height = 8.5}
# Perform graph-based louvain clustering
sample_290_normalized <- graph_clustering(
  sample_290_normalized,
  params_range = c(5:25),
  step_size = 5,
  weighting_type = "jaccard",
  cluster_function = "louvain"
)

# grab column names with clustering results
louvain_cols <- grep("walktrap", colnames(colData(sample_290_normalized)))
louvain_cluster_names <- colnames(colData(sample_290_normalized)[, louvain_cols])

# Plot
louvain_plot_list <- louvain_cluster_names %>%
   purrr::map(~ plotReducedDim(sample_290_normalized, dimred = "UMAP", colour_by = .x) + 
                theme_bw() +
                theme(text = element_text(size = 22)))


cowplot::plot_grid(plotlist = louvain_plot_list, ncol = 3)
```

## Check cluster validity stats

### k-means

```{r fig.height = 20.5}
# Check the k-means cluster validity stats for each of the clusters and return
# stats in a data frame
kmeans_stats_df <- create_metadata_stats_df(sample_290_normalized, c(4:10), 1, "kmeans")

# Preview the results
head(kmeans_stats_df)

# Summarize the stats and return in a data frame
kmeans_summary_stats_df <- summarize_clustering_stats(kmeans_stats_df)

# Preview the summary results
head(kmeans_summary_stats_df)
```

#### purity plots

```{r fig.height=10, fig.width=15}
# Plot individual cluster purity stats
kmeans_purity_plots <- plot_cluster_purity(kmeans_stats_df)

kmeans_purity_plots
```

#### silhouette width plots

```{r fig.height=10, fig.width=15}
# Plot individual cluster silhouette width stats
kmeans_silhouette_plots <- plot_cluster_silhouette_width(kmeans_stats_df)

kmeans_silhouette_plots
```

### graph-based, walktrap

```{r fig.height = 15.5}
# Check the walktrap cluster validity stats for each of the clusters and return
# stats in a data frame
walktrap_stats_df <- create_metadata_stats_df(sample_290_normalized, c(5:25), 5, "walktrap")
  
# Preview the all stats results
head(walktrap_stats_df)

# Summarize the stats and return in a data frame
walktrap_summary_stats_df <- summarize_clustering_stats(walktrap_stats_df)

# Preview the summary results
head(walktrap_summary_stats_df)
```

#### purity plots

```{r fig.height=10, fig.width=15}
# Plot individual cluster purity stats
walktrap_purity_plots <- plot_cluster_purity(walktrap_stats_df)

walktrap_purity_plots
```

#### silhouette width plots

```{r fig.height=10, fig.width=15}
# Plot individual cluster silhouette width stats
walktrap_silhouette_plots <- plot_cluster_silhouette_width(walktrap_stats_df)

walktrap_silhouette_plots
```

### graph-based, louvain

```{r fig.height = 9.5}
# Check the louvain cluster validity stats for each of the clusters and return
# stats in a data frame
louvain_stats_df <- create_metadata_stats_df(sample_290_normalized, c(5:25), 5, "louvain")

# Preview the results
head(louvain_stats_df)

# Summarize the stats and return in a data frame
louvain_summary_stats_df <- summarize_clustering_stats(louvain_stats_df)

# Preview the summary results
head(louvain_summary_stats_df)
```

#### purity plots

```{r fig.height=10}
# Plot individual cluster purity stats
louvain_purity_plots <- plot_cluster_purity(louvain_stats_df)

louvain_purity_plots
```

#### silhouette width plots

```{r fig.height=10}
# Plot individual cluster silhouette width stats
louvain_silhouette_plots <- plot_cluster_silhouette_width(louvain_stats_df)

louvain_silhouette_plots
```

### Summary plots

```{r}
summary_stats_df_list <- list("walktrap" = walktrap_summary_stats_df,
                              "louvain" = louvain_summary_stats_df)

# purity summary plot
plot_avg_validity_stats(summary_stats_df_list, "avg_purity")

#silhouette width summary plot
plot_avg_validity_stats(summary_stats_df_list, "avg_width")
```

## Check cluster stability

### k-means

```{r}
# Check cluster stability
kmeans_ari_df <- plot_cluster_stability(sample_290_normalized, c(4:10), 1, "kmeans")
kmeans_ari_df
```

### graph-based, walktrap

```{r warning=FALSE}
walktrap_ari_df <- plot_cluster_stability(sample_290_normalized, c(5:25), 5, cluster_type = "graph", cluster_function = "walktrap")
walktrap_ari_df
```

### graph-based, louvain

```{r warning=FALSE}
louvain_ari_df <- plot_cluster_stability(sample_290_normalized, c(5:25), 5, cluster_type = "graph", cluster_function = "louvain")
louvain_ari_df
```

## Session info

```{r}
sessionInfo()
```
