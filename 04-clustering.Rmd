---
title: "Clustering"
author: Data Lab for ALSF
date: 2022
output:
  html_notebook: 
    toc: true
    toc_float: true
---

This notebook will begin looking at clustering methods on the expression of the genes in a single sample of the dataset of interest, from an unbiased approach.

## Set Up 

```{r}
# Load libraries
library(magrittr)
library(scater)
library(readr)
library(bluster)
library(ggpubr)
library(pheatmap)

# Set file paths
data_dir <- file.path("results", "Gawad_processed_data")

# Source custom functions script
source(file.path("utils", "clustering-functions.R"))
```

## Read in data

```{r}
sample_290_normalized <- read_rds(
  file.path(data_dir, "SCPCS000216", "SCPCL000290_miQC_downstream_processed_normalized_reduced_sce.rds"))
```

## Perform clustering

### k-means

```{r fig.height = 10.5}
# Perform k-means clustering
kmeans_cluster_names <- paste0("kcluster", c(2:15))

sample_290_normalized <- kmeans_clustering(
  sample_290_normalized,
  k_range = c(2:15),
  check_stability = TRUE
)

# Plot k-means
kmeans_plot_list <- kmeans_cluster_names %>%
  purrr::map(~ plotReducedDim(sample_290_normalized, dimred = "UMAP", colour_by = .x))

cowplot::plot_grid(plotlist = kmeans_plot_list, ncol = 4)
```

### graph-based, walktrap

```{r fig.height = 9.5}
# Perform graph-based walktrap clustering
walktrap_cluster_names <-paste0("walktrap_cluster", c(5, 10, 15, 20, 25, 50, 100))

sample_290_normalized <- graph_clustering(
  sample_290_normalized,
  nn_range = c(5, 10, 15, 20, 25, 50, 100),
  weighting_type = "rank",
  cluster_function = "walktrap",
  check_stability = TRUE
)

# Plot
walktrap_plot_list <- walktrap_cluster_names %>%
   purrr::map(~ plotReducedDim(sample_290_normalized, dimred = "UMAP", colour_by = .x))

cowplot::plot_grid(plotlist = walktrap_plot_list, ncol = 3)
```

### graph-based, louvain

```{r fig.height = 8.5}
# Perform graph-based louvain clustering
louvain_cluster_names <- paste0("louvain_cluster", c(5, 10, 15, 20, 25, 50, 100))

sample_290_normalized <- graph_clustering(
  sample_290_normalized,
  nn_range = c(5, 10, 15, 20, 25, 50, 100),
  weighting_type = "jaccard",
  cluster_function = "louvain",
  check_stability = TRUE
)

# Plot
louvain_plot_list <- louvain_cluster_names %>%
   purrr::map(~ plotReducedDim(sample_290_normalized, dimred = "UMAP", colour_by = .x))


cowplot::plot_grid(plotlist = louvain_plot_list, ncol = 3)
```

## Check cluster validity stats

### k-means

```{r fig.height = 20.5}
# Check the k-means cluster validity stats for each of the clusters and produce
# a summary data frame of these stats to be stored within the SCE object
sample_290_normalized <- add_metadata_clustering_stats(sample_290_normalized, kmeans_cluster_names, "kmeans")

# Preview the saved results
head(metadata(sample_290_normalized)$all_stats$kmeans)

# Preview the saved summary results
head(metadata(sample_290_normalized)$summary_stats$kmeans)
```

#### purity plots

```{r fig.height=10, fig.width=15}
# Plot individual cluster and summary stats
kmeans_plots <- plot_clustering_validity(metadata(sample_290_normalized)$all_stats$kmeans,
                         metadata(sample_290_normalized)$summary_stats$kmeans,
                         "purity", "maximum", "cluster_names", c(2:15))
kmeans_plots
```

#### silhouette width plots

```{r fig.height=10, fig.width=15}
# Plot individual cluster and summary stats
kmeans_silhouette_plots <- plot_clustering_validity(metadata(sample_290_normalized)$all_stats$kmeans,
                         metadata(sample_290_normalized)$summary_stats$kmeans,
                         "width", "closest", "cluster_names", c(2:15))
kmeans_silhouette_plots
```

### graph-based, walktrap

```{r fig.height = 15.5}
# Check the walktrap cluster validity stats for each of the clusters and produce
# a summary data frame of these stats to be stored within the SCE object
sample_290_normalized <- add_metadata_clustering_stats(sample_290_normalized, walktrap_cluster_names, "walktrap")
  
# Preview the saved results
head(metadata(sample_290_normalized)$all_stats$walktrap)

# Preview the saved summary results
head(metadata(sample_290_normalized)$summary_stats$walktrap)
```
#### purity plots

```{r fig.height=10, fig.width=15}
# Plot individual cluster and summary stats
walktrap_plots <- plot_clustering_validity(metadata(sample_290_normalized)$all_stats$walktrap,
                         metadata(sample_290_normalized)$summary_stats$walktrap,
                         "purity", "maximum", "cluster_names", c(5, 10, 15, 20, 25, 50, 100))
walktrap_plots
```

#### silhouette width plots

```{r fig.height=10, fig.width=15}
# Plot individual cluster and summary stats
walktrap_silhouette_plots <- plot_clustering_validity(metadata(sample_290_normalized)$all_stats$walktrap,
                         metadata(sample_290_normalized)$summary_stats$walktrap,
                         "width", "closest", "cluster_names", c(5, 10, 15, 20, 25, 50, 100))
walktrap_silhouette_plots
```

### graph-based, louvain

```{r fig.height = 9.5}
# Check the louvain cluster validity stats for each of the clusters and produce
# a summary data frame of these stats to be stored within the SCE object
sample_290_normalized <- add_metadata_clustering_stats(sample_290_normalized, louvain_cluster_names, "louvain")

# Preview the saved results
head(metadata(sample_290_normalized)$all_stats$louvain)

# Preview the saved summary results
head(metadata(sample_290_normalized)$summary_stats$louvain)
```
#### purity plots

```{r fig.height=10}
# Plot individual cluster and summary stats
louvain_plots <- plot_clustering_validity(metadata(sample_290_normalized)$all_stats$louvain,
                         metadata(sample_290_normalized)$summary_stats$louvain,
                         "purity", "maximum", "cluster_names", c(5, 10, 15, 20, 25, 50, 100))
louvain_plots
```

#### silhouette width plots

```{r fig.height=10}
# Plot individual cluster and summary stats
louvain_silhouette_plots <- plot_clustering_validity(metadata(sample_290_normalized)$all_stats$louvain,
                         metadata(sample_290_normalized)$summary_stats$louvain,
                         "width", "closest", "cluster_names", c(5, 10, 15, 20, 25, 50, 100))
louvain_silhouette_plots
```

## Check cluster stability

### k-means

```{r}
# Check and plot cluster stability CDF
cdf <- NULL
for (name in kmeans_cluster_names) {
  cdf[[name]] <- prepare_plot_cluster_stability(sample_290_normalized, name)
}

colors <- palette.colors(palette = "Okabe-Ito")

plot(cdf[["kcluster2"]], verticals=TRUE, do.points=FALSE, main = "kcluster cluster stability CDF")
plot(cdf[["kcluster3"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[1])
plot(cdf[["kcluster4"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[2])
plot(cdf[["kcluster5"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[3])
plot(cdf[["kcluster6"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[4])
plot(cdf[["kcluster7"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[5])
plot(cdf[["kcluster8"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[6])
plot(cdf[["kcluster9"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[7])
plot(cdf[["kcluster10"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[8])
plot(cdf[["kcluster11"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[9])
plot(cdf[["kcluster12"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[10])
plot(cdf[["kcluster13"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[11])
plot(cdf[["kcluster14"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[12])
plot(cdf[["kcluster15"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[13])
legend(0.65, 0.95, legend = as.list(kmeans_cluster_names), col = colors, cex = 0.5, pch = 15)
```

### graph-based, walktrap

```{r}
# Check and plot cluster stability CDF
cdf <- NULL
for (name in walktrap_cluster_names) {
  cdf[[name]] <- prepare_plot_cluster_stability(sample_290_normalized, name)
}

colors <- palette.colors(palette = "Okabe-Ito")[2:length(walktrap_cluster_names) + 1]

plot(cdf[["walktrap_cluster5"]], verticals=TRUE, do.points=FALSE, main = "walktrap cluster stability CDF")
plot(cdf[["walktrap_cluster10"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[1])
plot(cdf[["walktrap_cluster15"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[2])
plot(cdf[["walktrap_cluster20"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[3])
plot(cdf[["walktrap_cluster25"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[4])
plot(cdf[["walktrap_cluster50"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[5])
plot(cdf[["walktrap_cluster100"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[6])
legend(-3, 0.95, legend = as.list(walktrap_cluster_names), col = colors, cex = 0.5, pch = 15)
```

### graph-based, louvain

```{r}
# Check and plot cluster stability CDF
cdf <- NULL
for (name in louvain_cluster_names) {
  cdf[[name]] <- prepare_plot_cluster_stability(sample_290_normalized, name)
}

colors <- palette.colors(palette = "Okabe-Ito")[2:length(louvain_cluster_names) + 1]

plot(cdf[["louvain_cluster5"]], verticals=TRUE, do.points=FALSE, main = "louvain cluster stability CDF")
plot(cdf[["louvain_cluster10"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[1])
plot(cdf[["louvain_cluster15"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[2])
plot(cdf[["louvain_cluster20"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[3])
plot(cdf[["louvain_cluster25"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[4])
plot(cdf[["louvain_cluster50"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[5])
plot(cdf[["louvain_cluster100"]], verticals=TRUE, do.points=FALSE, add=TRUE, col=colors[6])
legend(-0.25, 0.95, legend = as.list(louvain_cluster_names), col = colors, cex = 0.5, pch = 15)
```

## Session info

```{r}
sessionInfo()
```
