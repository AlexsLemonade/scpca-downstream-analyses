---
title: "Clustering"
author: Data Lab for ALSF
date: 2022
output:
  html_notebook: 
    toc: true
    toc_float: true
---

This notebook will begin looking at clustering methods on the expression of the genes in a single sample of the dataset of interest, from an unbiased approach.

## Set Up 

```{r}
# Load libraries
library(magrittr)
library(scater)
library(readr)
library(bluster)
library(ggpubr)
library(pheatmap)

# Set file paths
data_dir <- file.path("results", "Gawad_processed_data")

# Source custom functions script
source(file.path("utils", "clustering-functions.R"))
```

## Read in data

```{r}
sample_290_normalized <- read_rds(
  file.path(data_dir, "SCPCS000216", "SCPCL000290_miQC_downstream_processed_normalized_reduced_sce.rds"))
```

## Perform clustering

### k-means

```{r}
# Define empty cluster name object
kmeans_cluster_names <- c()

# Perform k-means clustering
for (i in 2:10) {
  kmeans_cluster_names <- c(kmeans_cluster_names, paste0("kcluster", i))
}

sample_290_normalized <- kmeans_clustering(
  sample_290_normalized,
  k_range = c(2:10),
  check_stability = TRUE
)

# Plot k-means
kmeans_plot_list <- kmeans_cluster_names %>%
  purrr::map(~ plotReducedDim(sample_290_normalized, dimred = "UMAP", colour_by = .x))

cowplot::plot_grid(plotlist = kmeans_plot_list, ncol = 3)
```

### graph-based, walktrap

```{r fig.height = 7.5}
# Define empty cluster name object
walktrap_cluster_names <- c()

# Perform graph-based walktrap clustering
for (i in c(5, 10, 15, 20, 25, 50)) {
  walktrap_cluster_names <-c(walktrap_cluster_names, paste0("walktrap_cluster", i))
}

sample_290_normalized <- graph_clustering(
  sample_290_normalized,
  nn_range = c(5, 10, 15, 20, 25, 50),
  weighting_type = "rank",
  cluster_function = "walktrap",
  check_stability = TRUE
)

# Plot
walktrap_plot_list <- walktrap_cluster_names %>%
   purrr::map(~ plotReducedDim(sample_290_normalized, dimred = "UMAP", colour_by = .x))

cowplot::plot_grid(plotlist = walktrap_plot_list, ncol = 3)
```

### graph-based, louvain

```{r fig.height = 6.5}
# Define empty cluster name object
louvain_cluster_names <- c()

# Perform graph-based louvain clustering
for (i in c(5, 10, 15, 20, 25, 50)) {
  cluster_name <- paste("louvain_cluster", i, sep = "")
  louvain_cluster_names <- c(louvain_cluster_names, paste0("louvain_cluster", i))
}

sample_290_normalized <- graph_clustering(
  sample_290_normalized,
  nn_range = c(5, 10, 15, 20, 25, 50),
  weighting_type = "jaccard",
  cluster_function = "louvain",
  check_stability = TRUE
)

# Plot
louvain_plot_list <- louvain_cluster_names %>%
   purrr::map(~ plotReducedDim(sample_290_normalized, dimred = "UMAP", colour_by = .x))


cowplot::plot_grid(plotlist = louvain_plot_list, ncol = 3)
```

## Check cluster validity stats

### k-means

```{r fig.height = 7.5}
# Check the k-means cluster validity stats
kmeans_cluster_validity_df_list <- kmeans_cluster_names %>%
  purrr::map(~ cluster_validity_stats(sample_290_normalized, .x))
names(kmeans_cluster_validity_df_list) <- kmeans_cluster_names
kmeans_cluster_validity_df <- dplyr::bind_rows(kmeans_cluster_validity_df_list,
                                       .id = "kmeans_n")
# Plot the k-means cluster purity
plot_clustering_validity(kmeans_cluster_validity_df, "purity", "maximum", "kmeans_n")
# Plot k-means cluster silhouette
plot_clustering_validity(kmeans_cluster_validity_df, "width", "closest", "kmeans_n")
```
### graph-based, walktrap

```{r fig.height = 7.5}
# Check the walktrap cluster validity stats
walktrap_cluster_validity_df_list <- walktrap_cluster_names %>%
  purrr::map(~ cluster_validity_stats(sample_290_normalized, .x))
names(walktrap_cluster_validity_df_list) <- walktrap_cluster_names
walktrap_cluster_validity_df <- dplyr::bind_rows(walktrap_cluster_validity_df_list,
                                       .id = "walktrap_n")

# Plot the graph-based walktrap cluster purity
plot_clustering_validity(walktrap_cluster_validity_df, "purity", "maximum", "walktrap_n")
# Plot graph-based walktrap cluster silhouette
plot_clustering_validity(walktrap_cluster_validity_df, "width", "closest", "walktrap_n")
```
### graph-based, louvain

```{r fig.height = 7.5}
# Check the louvain cluster validity stats
louvain_cluster_validity_df_list <- louvain_cluster_names %>%
  purrr::map(~ cluster_validity_stats(sample_290_normalized, .x))
names(louvain_cluster_validity_df_list) <- louvain_cluster_names
louvain_cluster_validity_df <- dplyr::bind_rows(louvain_cluster_validity_df_list,
                                       .id = "louvain_n")

# Plot the graph-based louvain cluster purity
plot_clustering_validity(louvain_cluster_validity_df, "purity", "maximum", "louvain_n")
# Plot graph-based louvain cluster silhouette
plot_clustering_validity(louvain_cluster_validity_df, "width", "closest", "louvain_n")
```

## Check cluster stability

### k-means

```{r}
# Check and plot cluster stability
kmeans_cluster_names %>%
  purrr::walk(~ plot_cluster_stability(sample_290_normalized, .x))
```

### graph-based, walktrap

```{r}
walktrap_cluster_names %>%
  purrr::walk(~ plot_cluster_stability(sample_290_normalized, .x))
```

### graph-based, louvain

```{r}
louvain_cluster_names %>%
  purrr::walk(~ plot_cluster_stability(sample_290_normalized, .x))
```

## Session info

```{r}
sessionInfo()
```
